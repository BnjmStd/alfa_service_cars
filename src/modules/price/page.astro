---
const { phone = "56912345678" } = Astro.props;
import { getCollection } from "astro:content";
import { Image } from "astro:assets";

const collectionServices = await getCollection("services");

const itemsBento = collectionServices.map((service) => ({
  title: service.data.title,
  description: service.data.description,
  imageSrc: service.data.imageSrc,
  videoSrc: service.data.videoSrc || null,
  href: service.data.href,
  whatsappTag: service.data.title,
}));

console.log(phone);

const QUOTE_CONFIG = {
  servicio: {
    label: "1. Selecciona el tratamiento",
    source: "services",
  },
  tamano: {
    label: "2. Tipo de veh√≠culo",
    options: [
      { label: "City Car", value: "City Car", icon: "üöó" },
      { label: "Sed√°n", value: "Sed√°n", icon: "üöò" },
      { label: "Hatchback", value: "Hatchback", icon: "üöñ" },
      {
        label: "Motocicleta",
        value: "Motocicleta",
        icon: "üèçÔ∏è",
      },
      { label: "Pick-up", value: "Pick-up", icon: "üõª" },
      { label: "Van / Furg√≥n", value: "Van / Furg√≥n", icon: "üöê" },
      { label: "Camioneta XL", value: "Camioneta XL", icon: "üöõ" },
      { label: "Deportivo", value: "Deportivo", icon: "üèéÔ∏è" },
    ],
  },
};
---

<section id="cotizar" class="quote-section">
  <div class="container">
    <div class="quote-container reveal">
      <span class="badge" id="status-text">Configura tu solicitud</span>
      <h2 class="quote-title">
        Lleva tu auto al <span class="text-accent">Siguiente Nivel</span>
      </h2>

      <label class="apple-label">1. Selecciona el tratamiento</label>
      <div class="options-grid" data-group="servicio">
        {
          itemsBento.map((item) => (
            <div class="option-card" data-value={item.whatsappTag}>
              {item.imageSrc ? (
                <Image src={item.imageSrc} alt={item.title} />
              ) : (
                <i>‚ú®</i>
              )}
              <span>{item.title}</span>
            </div>
          ))
        }
      </div>

      <label class="apple-label">2. Tama√±o del veh√≠culo</label>

      <div class="options-grid" data-group="tamano">
        {
          QUOTE_CONFIG.tamano.options.map((option) => (
            <div
              class="option-card"
              data-group="tamano"
              data-value={option.value}
            >
              <i>{option.icon}</i>
              <span>{option.label}</span>
            </div>
          ))
        }
      </div>

      <label class="apple-label">3. Tus datos</label>
      <input
        type="text"
        id="user-name"
        class="apple-input"
        placeholder="Nombre completo"
      />

      <button class="btn btn-primary" id="send-whatsapp">
        Cotizar por WhatsApp
      </button>
    </div>
  </div>
</section>

<script is:inline define:vars={{ phone }}>
  // Variables de estado
  let selectedServicio = "";
  let selectedTamano = "";

  // Seleccion de opciones con delegaci√≥n de eventos
  document.querySelectorAll(".options-grid .option-card").forEach((card) => {
    card.addEventListener("click", () => {
      const parent = card.parentElement;
      const group = parent.dataset.group;

      // Limpiar selecci√≥n del grupo
      parent
        .querySelectorAll(".option-card")
        .forEach((c) => c.classList.remove("selected"));

      // Activar clickeado
      card.classList.add("selected");

      // Guardar valor
      if (group === "servicio") selectedServicio = card.dataset.value;
      if (group === "tamano") selectedTamano = card.dataset.value;

      updateStatus();
    });
  });

  function updateStatus() {
    const statusText = document.getElementById("status-text");
    if (selectedServicio && selectedTamano) {
      statusText.innerText = "¬°Listo para cotizar!";
      statusText.style.borderColor = "white";
      statusText.style.color = "white";
    }
  }

  // L√≥gica de WhatsApp
  document.getElementById("send-whatsapp").addEventListener("click", () => {
    const name = document.getElementById("user-name").value.trim();

    if (!selectedServicio || !selectedTamano) {
      alert("‚ö†Ô∏è Por favor selecciona un servicio y tipo de veh√≠culo");
      return;
    }

    if (!name) {
      alert("‚ö†Ô∏è Por favor ingresa tu nombre para continuar");
      return;
    }

    const baseMsg = `¬°Hola Alfa Detailers! üëã

Me gustar√≠a solicitar una cotizaci√≥n:

‚ú® *Servicio:* ${selectedServicio}
üöó *Veh√≠culo:* ${selectedTamano}
üë§ *Mi nombre:* ${name}

¬øPodr√≠an darme m√°s informaci√≥n sobre precios y disponibilidad?

¬°Gracias!`;

    const encodedMsg = encodeURIComponent(baseMsg);
    const cleanPhone = phone.replace(/\D/g, "");
    window.open(`https://wa.me/${cleanPhone}?text=${encodedMsg}`, "_blank");
  });
</script>

<style>
  @layer components {
    .quote-section {
      padding: 100px 0;
    }

    .quote-container {
      max-width: 800px;
      margin: 0 auto;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(var(--glass-blur));
      border-radius: 32px;
      padding: 50px;
    }

    .quote-title {
      font-size: clamp(2rem, 5vw, 2.8rem);
      margin-bottom: 40px;
      font-weight: 800;
      line-height: 1.1;
    }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 15px;
      margin-bottom: 35px;
    }

    .option-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--glass-border);
      padding: 25px 15px;
      border-radius: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    /* Animaci√≥n de pulso al seleccionar */
    .option-card.selected {
      border-color: var(--color-accent);
      background: rgba(217, 4, 41, 0.1);
      transform: scale(1.05);
      box-shadow: 0 0 20px var(--color-accent-glow);
    }

    .option-card i {
      font-size: 1.8rem;
      transition: transform 0.3s ease;
    }
    .option-card:hover i {
      transform: translateY(-5px);
    }

    .apple-input {
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--glass-border);
      padding: 18px 25px;
      border-radius: 18px;
      color: white;
      font-size: 1rem;
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }

    .apple-input:focus {
      outline: none;
      border-color: var(--color-accent);
      background: rgba(255, 255, 255, 0.1);
    }

    .apple-label {
      display: block;
      margin-bottom: 10px;
      font-size: 0.9rem;
      color: var(--color-text-muted);
      font-weight: 500;
    }
  }
</style>
