---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";

// Recibir props del schema
const { serviceId, subtitle, title, description, imagenAntes: propImagenAntes, imagenDespues: propImagenDespues } = Astro.props;
const currentService = serviceId || Astro.params.id;

let imagenAntes, imagenDespues;

// Si vienen las imágenes directamente en props (ahora son objetos de Image)
if (propImagenAntes && propImagenDespues) {
  imagenAntes = { data: { foto: propImagenAntes } };
  imagenDespues = { data: { foto: propImagenDespues } };
} else {
  // Buscar automáticamente por serviceId (comportamiento anterior)
  const comparativas = (await getCollection("gallery")).filter((item) =>
    item.id.includes("comparative") &&
    currentService &&
    item.id.startsWith(currentService)
  );
  
  imagenAntes = comparativas[0];
  imagenDespues = comparativas[1] || comparativas[0];
}
---

<section class="comparison-section">
  <div class="container">
    <div class="section-header reveal">
      {subtitle && (
        <span class="badge">{subtitle}</span>
      )}
      <h2 style="font-size: clamp(2rem, 4vw, 3rem);">
        {title || "Resultados que hablan."}
      </h2>
      {description && <p class="section-description">{description}</p>}
    </div>

    {imagenAntes && imagenDespues ? (
      <div class="comparison-container reveal">
        <Image
          src={imagenDespues.data.foto}
          alt="Después"
          class="comparison-img"
          width={900}
          height={506}
          loading="eager"
        />
        <span class="label-comparison" style="right: 20px;">Después</span>

        <Image
          id="beforeImg"
          src={imagenAntes.data.foto}
          alt="Antes"
          class="comparison-img img-before"
          width={900}
          height={506}
          loading="eager"
        />
        <span class="label-comparison" style="left: 20px;">Antes</span>

      <div id="line" class="slider-line"></div>
      <div id="button" class="slider-button"></div>

      <label for="slider" class="visually-hidden">Comparar antes y después</label>
      <input
        type="range"
        min="0"
        max="100"
        value="50"
        class="comparison-slider"
        id="slider"
        aria-label="Control de comparación antes y después"
      />
    </div>
    ) : (
      <div class="no-comparison">
        <p>No hay imágenes comparativas disponibles para este servicio.</p>
      </div>
    )}
  </div>
</section>

<script>
  function initComparison() {
    const slider = document.getElementById("slider") as HTMLInputElement | null;
    const beforeImg = document.getElementById("beforeImg") as HTMLElement | null;
    const line = document.getElementById("line") as HTMLElement | null;
    const button = document.getElementById("button") as HTMLElement | null;

    if (!slider || !beforeImg || !line || !button) return;

    slider.addEventListener("input", (e) => {
      const value = (e.target as HTMLInputElement).value;
      // Cortamos la imagen de la derecha basándonos en el slider
      beforeImg.style.clipPath = `inset(0 ${100 - Number(value)}% 0 0)`;
      // Movemos la línea y el botón
      line.style.left = `${value}%`;
      button.style.left = `${value}%`;
    });
  }

  // Inicializar en carga de página y navegaciones SPA
  document.addEventListener("astro:page-load", initComparison);
</script>

<style>
  @layer components {
    .comparison-section {
      background: var(--color-bg-surface);
      padding: 100px 0;
    }

    .section-description {
      max-width: 700px;
      margin: 20px auto 0;
      text-align: center;
      color: var(--color-text-muted);
      font-size: 1rem;
      line-height: 1.6;
    }

    /* Contenedor del Slider */
    .comparison-container {
      position: relative;
      width: 100%;
      max-width: 900px;
      aspect-ratio: 16 / 9;
      margin: 0 auto;
      border-radius: var(--border-radius-lg);
      overflow: hidden;
      border: 1px solid var(--glass-border);
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
      /* Forzar el height mínimo para evitar colapso durante carga */
      min-height: 300px;
    }

    .comparison-img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      pointer-events: none;
      /* Evitar el flash de contenido sin estilo */
      display: block;
    }

    /* Imagen superior (La que se recorta) */
    .img-before {
      z-index: 2;
      /* El clip-path creará el recorte dinámico */
      clip-path: inset(0 50% 0 0);
      will-change: clip-path;
    }

    /* La barra deslizadora */
    .comparison-slider {
      position: absolute;
      inset: 0;
      z-index: 3;
      cursor: ew-resize;
      appearance: none;
      background: transparent;
      width: 100%;
    }

    /* Estilo de la línea divisoria */
    .slider-line {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 50%;
      width: 2px;
      background: white;
      z-index: 4;
      pointer-events: none;
      box-shadow: 0 0 15px var(--color-accent-glow);
      will-change: left;
    }

    /* El círculo del centro (Handle) */
    .slider-button {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 44px;
      height: 44px;
      background: white;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 5;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      pointer-events: none;
      will-change: left;
    }

    .slider-button::before,
    .slider-button::after {
      content: "";
      border: 6px solid transparent;
    }
    .slider-button::before {
      border-right-color: var(--color-accent);
      margin-right: 4px;
    }
    .slider-button::after {
      border-left-color: var(--color-accent);
      margin-left: 4px;
    }

    .label-comparison {
      position: absolute;
      bottom: 20px;
      padding: 5px 15px;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      border-radius: 5px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      z-index: 6;
    }

    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  }
</style>